version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: query-generator-backend-prod
    ports:
      - "${BACKEND_PORT:-5000}:5000"
    environment:
      - FLASK_ENV=production
      - FLASK_DEBUG=false
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=5000
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
      - APP_VERSION=${APP_VERSION:-1.0.0}
      - GUNICORN_WORKERS=${GUNICORN_WORKERS:-2}
      - GUNICORN_THREADS=${GUNICORN_THREADS:-2}
    networks:
      - query-generator-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/api/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '${BACKEND_CPU_LIMIT:-1.0}'
          memory: ${BACKEND_MEMORY_LIMIT:-512M}
        reservations:
          cpus: '${BACKEND_CPU_RESERVATION:-0.5}'
          memory: ${BACKEND_MEMORY_RESERVATION:-256M}
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    volumes:
      - ./logs/backend:/app/logs

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: query-generator-frontend-prod
    ports:
      - "${FRONTEND_PORT_HTTP:-9000}:9000"
      - "${FRONTEND_PORT_HTTPS:-443}:443"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - query-generator-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '${FRONTEND_CPU_LIMIT:-0.5}'
          memory: ${FRONTEND_MEMORY_LIMIT:-256M}
        reservations:
          cpus: '${FRONTEND_CPU_RESERVATION:-0.25}'
          memory: ${FRONTEND_MEMORY_RESERVATION:-128M}
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    # 如果使用HTTPS，取消下面的注释并挂载SSL证书
    # volumes:
    #   - ./ssl:/etc/nginx/ssl:ro
    #   - ./frontend/nginx-ssl.conf:/etc/nginx/conf.d/default.conf:ro

networks:
  query-generator-network:
    driver: bridge

